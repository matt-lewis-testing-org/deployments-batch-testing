name: Output Scheduled Actions
description: ""

inputs:
  token:
    description: The GitHub token used to create an authenticated client
    default: ${{ github.token }}
    required: false
  variables_json:
    description: 'JSON string of variables'
    required: true
    default: ''

runs:
  using: "composite"
  steps:
    - name: Generate Deployment Summary
      uses: actions/github-script@v6
      env:
        VARIABLES_JSON: "${{ inputs.variables_json }}"
      with:
        script: |
          const summary = core.summary;
          
          const inputJson = process.env.VARIABLES_JSON;
          let variables;
          try {
            variables = JSON.parse(inputJson);
          } catch (e) {
            console.error('Failed to parse input JSON:', e);
            process.exit(1);
          }
          
          let tableRows = [];
          tableRows.push([
            { data: 'Variable Name', header: true },
            { data: 'Cluster Name', header: true },
            { data: 'Chart Name', header: true },
            { data: 'Version', header: true }
          ]);

          for (const key of Object.keys(variables)) {
            if (!key.startsWith('_SCHEDULE_')) continue;

            const value = variables[key];
            const commaIndex = value.indexOf(',');
            if (commaIndex === -1) {
              console.log(`No comma found for ${key}, skipping`);
              continue;
            }

            let jsonStr = value.substring(commaIndex + 1).trim();

            let data;
            try {
              data = JSON.parse(jsonStr);
              if (typeof data === 'string') {
                data = JSON.parse(data);
              }
            } catch (err) {
              console.log(`Failed to parse JSON for ${key}: ${err}`);
              continue;
            }

            const clusterName = data.cluster_name || data.cluster || '';
            const chartName = data.chart_name || '';
            const version = data.version || data.chart_version || '';

            tableRows.push([
              { data: key },
              { data: clusterName },
              { data: chartName },
              { data: version }
            ]);
          }

          await summary
            .addHeading('Deployment Summary', 2)
            .addTable(tableRows)
            .write();
